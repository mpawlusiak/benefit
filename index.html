<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flipbook (PDF.js, no Turn.js)</title>
<style>
  :root{ --page-shadow: 0 12px 28px rgba(0,0,0,.28), 0 2px 8px rgba(0,0,0,.18); --flip-ms: 900ms; }
  html,body{height:100%;margin:0;background:transparent;}
  .wrap{position:fixed;inset:0;display:grid;place-items:center;background:transparent;}
  #book{position:relative; background:transparent; perspective:2000px; user-select:none;}
  .spread{position:relative; display:grid; grid-template-columns:1fr 1fr; gap:0; align-items:stretch;}
  .page{position:relative; background:#fff; box-shadow:var(--page-shadow); overflow:hidden;}
  .page canvas{position:absolute; inset:0; width:100%; height:100%;}
  .textLayer{position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;}
  .textLayer>span{position:absolute; white-space:pre; transform-origin:0 0; line-height:1; color:transparent; text-shadow:0 0 0 #000;}
  .edge-shadow{position:absolute; top:0; bottom:0; width:60px; pointer-events:none; opacity:0; transition:opacity .25s ease;}
  .edge-shadow.left{left:0; background:linear-gradient(90deg, rgba(0,0,0,.18), rgba(0,0,0,0));}
  .edge-shadow.right{right:0; background:linear-gradient(270deg, rgba(0,0,0,.18), rgba(0,0,0,0));}
  .nav{position:absolute; top:50%; transform:translateY(-50%); z-index:10;}
  .btn{width:56px;height:56px;border-radius:999px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.85);box-shadow:0 8px 20px rgba(0,0,0,.2);display:grid;place-items:center;cursor:pointer;transition:transform .2s ease, opacity .2s ease;}
  .btn:hover{transform:translateY(-50%) scale(1.04);}
  .btn[hidden]{opacity:0;pointer-events:none;}
  .nav.left{left:2.5%} .nav.right{right:2.5%}
  .hint{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.9);font:500 13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:8px 12px;border-radius:999px;box-shadow:0 6px 16px rgba(0,0,0,.18);opacity:0;animation:fade 3s ease 1s 1 forwards;pointer-events:none;}
  @keyframes fade{0%{opacity:0}15%{opacity:1}85%{opacity:1}100%{opacity:0}}
  /* Flip animation (right page flips left) */
  .flip-right {transform-origin:left center; transform:rotateY(0); animation:flipRight var(--flip-ms) ease forwards;}
  @keyframes flipRight {
    0%   { transform: rotateY(0deg);   filter:brightness(1); }
    50%  { filter:brightness(.92); }
    100% { transform: rotateY(-180deg); filter:brightness(.88); }
  }
  /* Flip animation (left page flips right, on going backwards) */
  .flip-left {transform-origin:right center; transform:rotateY(0); animation:flipLeft var(--flip-ms) ease forwards;}
  @keyframes flipLeft {
    0%   { transform: rotateY(0deg);   filter:brightness(1); }
    50%  { filter:brightness(.92); }
    100% { transform: rotateY(180deg); filter:brightness(.88); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div id="book" aria-label="Interactive booklet">
    <div class="spread" id="spread">
      <div class="page" id="left"><canvas></canvas><div class="textLayer"></div><div class="edge-shadow left"></div></div>
      <div class="page" id="right"><canvas></canvas><div class="textLayer"></div><div class="edge-shadow right"></div></div>
    </div>
    <div class="nav left"><button class="btn" id="prev" aria-label="Previous" hidden>
      <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button></div>
    <div class="nav right"><button class="btn" id="next" aria-label="Next" hidden>
      <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
    </button></div>
    <div class="hint">Tap or use arrows to flip</div>
  </div>
</div>

<!-- PDF.js -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
</script>

<script>
const PDF_URL = "./beNeFit%20XIII%20-%20Benefactors%20Booklet.pdf";  // same-folder PDF
const BASE_SCALE = 1.25;

const book = document.getElementById('book');
const spread = document.getElementById('spread');
const left = document.getElementById('left');
const right = document.getElementById('right');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');

let pdf, numPages=0, current=1, pageW=800, pageH=1100;

function computeSizes(){
  const cw = Math.min(window.innerWidth*0.92, 1600);
  const ch = window.innerHeight*0.92;
  const bookAspect = (pageW*2)/pageH;
  let bookW = cw, bookH = bookW/bookAspect;
  if (bookH>ch){ bookH=ch; bookW=bookH*bookAspect; }
  spread.style.width = Math.floor(bookW)+'px';
  spread.style.height = Math.floor(bookH)+'px';
  for (const p of [left,right]){
    p.style.width = Math.floor(bookW/2)+'px';
    p.style.height = Math.floor(bookH)+'px';
  }
}

async function renderPage(n, sideEl){
  const page = await pdf.getPage(n);
  const vp1 = page.getViewport({scale:1});
  // store page aspect from first page
  pageW = vp1.width; pageH = vp1.height;
  computeSizes();
  const targetW = sideEl.clientWidth;
  const scale = (targetW / vp1.width) * (window.devicePixelRatio||1) * BASE_SCALE;
  const vp = page.getViewport({scale});

  const canvas = sideEl.querySelector('canvas');
  const ctx = canvas.getContext('2d', {alpha:false});
  canvas.width = Math.max(1, Math.floor(vp.width));
  canvas.height = Math.max(1, Math.floor(vp.height));
  canvas.style.width = sideEl.clientWidth+'px';
  canvas.style.height = sideEl.clientHeight+'px';

  sideEl.querySelector('.textLayer').innerHTML = '';
  await page.render({canvasContext:ctx, viewport:vp}).promise;

  const text = await page.getTextContent();
  text.items.forEach((it)=>{
    const s=document.createElement('span');
    s.textContent=it.str;
    const t=it.transform; const fh=Math.hypot(t[2],t[3]); const x=t[4], y=t[5];
    const [a,b,c,d,e,f] = vp.transform;
    const cssX=a*x + c*y + e;
    const cssY=b*x + d*y + f;
    s.style.left=cssX+'px';
    s.style.top=(cssY - fh)+'px';
    s.style.fontSize=fh+'px';
    s.style.transform=`matrix(${t[0]},${t[1]},${t[2]},${t[3]},0,0)`;
    sideEl.querySelector('.textLayer').appendChild(s);
  });
}

function syncArrows(){
  prevBtn.hidden = current<=1;
  nextBtn.hidden = current>=numPages;
}

async function goNext(){
  if (current>=numPages) return;
  // animate right page flipping left
  right.classList.add('flip-right');
  right.querySelector('.edge-shadow.right').style.opacity = 1;
  await new Promise(r=>setTimeout(r, 0.66*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--flip-ms'))));
  current++;
  await renderSpread();
  right.classList.remove('flip-right');
  right.querySelector('.edge-shadow.right').style.opacity = 0;
}

async function goPrev(){
  if (current<=1) return;
  // animate left page flipping right
  left.classList.add('flip-left');
  left.querySelector('.edge-shadow.left').style.opacity = 1;
  await new Promise(r=>setTimeout(r, 0.66*parseInt(getComputedStyle(document.documentElement).getPropertyValue('--flip-ms'))));
  current--;
  await renderSpread();
  left.classList.remove('flip-left');
  left.querySelector('.edge-shadow.left').style.opacity = 0;
}

async function renderSpread(){
  const l = Math.max(1, current-1);
  const r = Math.min(numPages, current);
  await renderPage(l, left);
  await renderPage(r, right);
  syncArrows();
}

window.addEventListener('resize', ()=>{ computeSizes(); });

document.addEventListener('keydown', (e)=>{
  if (e.key==='ArrowRight') goNext();
  if (e.key==='ArrowLeft')  goPrev();
});
right.addEventListener('click', goNext);
left.addEventListener('click', goPrev);
prevBtn.addEventListener('click', goPrev);
nextBtn.addEventListener('click', goNext);

(async function init(){
  try{
    pdf = await pdfjsLib.getDocument({ url: PDF_URL, withCredentials:false }).promise;
    numPages = pdf.numPages;
    await renderSpread();
  }catch(err){
    console.error(err);
    const msg=document.createElement('div');
    msg.style.cssText="color:#900;font:14px/1.5 system-ui;padding:16px;background:rgba(255,255,255,.8);border:1px solid #f6dcdc;border-radius:12px;";
    msg.textContent="Flipbook failed to initialize. Open the console for details.";
    book.appendChild(msg);
  }
})();
</script>
</body>
</html>
